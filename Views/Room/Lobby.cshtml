@{
    ViewBag.Title = "Oyun Lobby";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var room = ViewBag.Room as casus_oyunu.Models.GameRoom;
    var participants = ViewBag.Participants as List<casus_oyunu.Models.RoomParticipant>;
    var gameState = ViewBag.GameState as casus_oyunu.Models.GameState;
    var votes = ViewBag.Votes as List<casus_oyunu.Models.Vote>;
}

@section Styles {
    <link rel="stylesheet" href="~/css/lobby.css" asp-append-version="true" />
}

<div class="lobby-container">
    <div class="container-fluid">
        <div class="row">
            <!-- Sol Panel - Oyuncular ve Oda Bilgileri -->
            <div class="col-lg-4">
                <div class="lobby-sidebar">
                    <!-- Oda Bilgileri -->
                    <div class="card mb-3 border-0 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-door-open me-2"></i>Oda Bilgileri
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="room-info">
                                <div class="info-item d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Oda Kodu:</span>
                                    <span class="badge bg-primary fs-6">@room?.RoomCode</span>
                                </div>
                                <div class="info-item d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Kurucu:</span>
                                    <span class="fw-bold">@room?.Creator?.UserName</span>
                                </div>
                                <div class="info-item d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Durum:</span>
                                    @if (gameState?.Started == true && !gameState.Finished)
                                    {
                                        <span class="badge bg-warning">Oyun Devam Ediyor</span>
                                    }
                                    else if (gameState?.Finished == true)
                                    {
                                        <span class="badge bg-secondary">Oyun Bitti</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Beklemede</span>
                                    }
                                </div>
                                @if (gameState?.Started == true)
                                {
                                    <div class="info-item d-flex justify-content-between align-items-center">
                                        <span class="text-muted">Kalan Süre:</span>
                                        <span class="fw-bold text-danger" id="timer">--:--</span>
                                    </div>
                                }
                            </div>
                            
                            <!-- Oda Kodu Paylaşım -->
                            <div class="share-section mt-3">
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="shareRoom()">
                                    <i class="fas fa-share me-2"></i>Oda Kodunu Paylaş
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Oyuncular Listesi -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-users me-2"></i>Oyuncular (@participants?.Count)
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="players-list" id="playersList">
                                @if (participants != null && participants.Any())
                                {
                                    foreach (var participant in participants)
                                    {
                                        <div class="player-item d-flex align-items-center p-2 mb-2 bg-light rounded">
                                            <div class="player-avatar me-3">
                                                <i class="fas fa-user-circle text-primary fs-4"></i>
                                            </div>
                                            <div class="player-info flex-grow-1">
                                                <div class="player-name fw-bold">
                                                    @(participant.User?.UserName ?? "Bilinmeyen Oyuncu")
                                                </div>
                                                <div class="player-status text-muted small">
                                                    @if (participant.User?.Id == room?.CreatorId)
                                                    {
                                                        <span class="badge bg-primary">Kurucu</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-success">Oyuncu</span>
                                                    }
                                                </div>
                                            </div>
                                            @if (gameState?.Started == true && !gameState.Finished)
                                            {
                                                <div class="player-vote">
                                                    @if (votes?.Any(v => v.TargetParticipantId == participant.Id) == true)
                                                    {
                                                        <span class="badge bg-danger">@votes.Count(v => v.TargetParticipantId == participant.Id) Oy</span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="text-center text-muted">
                                        <i class="fas fa-users fs-4 mb-2"></i>
                                        <p>Henüz oyuncu yok</p>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sağ Panel - Oyun Kontrolleri -->
            <div class="col-lg-8">
                <div class="lobby-main">
                    <!-- Oyun Durumu -->
                    @if (gameState?.Started == true && !gameState.Finished)
                    {
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="fas fa-gamepad me-2"></i>Oyun Devam Ediyor
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="game-status text-center">
                                    <div class="timer-display mb-3">
                                        <h2 class="text-danger fw-bold" id="gameTimer">--:--</h2>
                                        <p class="text-muted">Kalan Süre</p>
                                    </div>
                                    <div class="game-instructions">
                                        <p class="lead">Casusu bulmak için sorular sorun!</p>
                                        <div class="progress mb-3" style="height: 10px;">
                                            <div class="progress-bar bg-danger" id="timerProgress" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else if (gameState?.Finished == true)
                    {
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-flag-checkered me-2"></i>Oyun Bitti
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="game-result text-center">
                                    <h4 class="mb-3">@gameState?.FinishMessage</h4>
                                    <div class="result-actions">
                                        <form method="post" asp-action="Rematch" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="code" value="@room?.RoomCode" />
                                            <button type="submit" class="btn btn-primary btn-lg me-3">
                                                <i class="fas fa-redo me-2"></i>Rematch
                                            </button>
                                        </form>
                                        <a href="@Url.Action("Create", "Room")" class="btn btn-outline-primary btn-lg">
                                            <i class="fas fa-plus me-2"></i>Yeni Oyun
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <!-- Oyun Başlatma -->
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-play me-2"></i>Oyunu Başlat
                                </h5>
                            </div>
                            <div class="card-body">
                                @if (room?.CreatorId.ToString() == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value)
                                {
                                    <div class="start-game-section">
                                        @if (string.IsNullOrEmpty(room?.SelectedWords))
                                        {
                                            <div class="text-center">
                                                <p class="lead mb-3">Oyunu başlatmak için önce kelimeleri seçin</p>
                                                <a href="@Url.Action("SelectWords", "Room", new { code = room?.RoomCode })" class="btn btn-primary btn-lg">
                                                    <i class="fas fa-list me-2"></i>Kelimeleri Seç
                                                </a>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="text-center">
                                                <p class="lead mb-3">Herkes hazır! Oyunu başlatabilirsiniz</p>
                                                <form method="post" asp-action="StartGame">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="code" value="@room?.RoomCode" />
                                                    <button type="submit" class="btn btn-success btn-lg">
                                                        <i class="fas fa-play me-2"></i>Oyunu Başlat
                                                    </button>
                                                </form>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="text-center">
                                        <p class="lead">Oyun kurucusu oyunu başlatmayı bekliyor...</p>
                                        <div class="loading-spinner">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Yükleniyor...</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Oyun Ayarları -->
                    @if (room?.SelectedWords != null)
                    {
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-cog me-2"></i>Oyun Ayarları
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="game-settings">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="setting-item">
                                                <label class="fw-bold">Seçilen Kategoriler:</label>
                                                <p class="text-muted">@room.SelectedCategories</p>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="setting-item">
                                                <label class="fw-bold">Seçilen Kelimeler:</label>
                                                <p class="text-muted">@room.SelectedWords</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
<script>
let connection;
let timerInterval;

// SignalR bağlantısı
async function startConnection() {
    connection = new signalR.HubConnectionBuilder()
        .withUrl("/gameHub")
        .build();

    try {
        await connection.start();
        console.log("SignalR Connected.");
        
        // Odaya katıl
        await connection.invoke("JoinRoom", "@room?.RoomCode");
        
        // Event listeners
        connection.on("UserJoined", function (userName) {
            location.reload();
        });
        
        connection.on("UserLeft", function (userName) {
            location.reload();
        });
        
        connection.on("GameStarted", function (roomCode) {
            location.reload();
        });
        
        connection.on("GameEnded", function (message) {
            location.reload();
        });
        
        connection.on("VoteReceived", function (targetId, voterName) {
            location.reload();
        });
        
    } catch (err) {
        console.error(err);
        setTimeout(startConnection, 5000);
    }
}

// Timer fonksiyonu
function startTimer(duration) {
    let timer = duration;
    const timerElement = document.getElementById('gameTimer');
    const timerProgress = document.getElementById('timerProgress');
    const progressBar = document.getElementById('timerProgress');
    
    if (timerElement && progressBar) {
        timerInterval = setInterval(function () {
            const minutes = parseInt(timer / 60, 10);
            const seconds = parseInt(timer % 60, 10);

            timerElement.textContent = 
                (minutes < 10 ? "0" + minutes : minutes) + ":" + 
                (seconds < 10 ? "0" + seconds : seconds);

            const progress = ((duration - timer) / duration) * 100;
            progressBar.style.width = progress + "%";

            if (--timer < 0) {
                clearInterval(timerInterval);
                location.reload();
            }
        }, 1000);
    }
}

// Oda paylaşımı
function shareRoom() {
    const roomCode = "@room?.RoomCode";
    const shareText = `casusmusunnesin? oyununa katılın! Oda kodu: ${roomCode}`;
    const shareUrl = `${window.location.origin}/Room/Join?roomCode=${roomCode}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'casusmusunnesin?',
            text: shareText,
            url: shareUrl
        });
    } else {
        // Fallback: kopyala
        navigator.clipboard.writeText(`${shareText}\n${shareUrl}`).then(() => {
            alert('Oda bilgileri panoya kopyalandı!');
        });
    }
}

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
    startConnection();
    
    // Timer başlat (eğer oyun devam ediyorsa)
    @if (gameState?.Started == true && !gameState.Finished && gameState.StartedAt.HasValue)
    {
        <text>
        const remainingTime = @(gameState.DurationSeconds - (int)(DateTime.UtcNow - gameState.StartedAt.Value).TotalSeconds);
        if (remainingTime > 0) {
            startTimer(remainingTime);
        }
        </text>
    }
});

// Sayfa kapatılırken bağlantıyı kapat
window.addEventListener('beforeunload', function() {
    if (connection) {
        connection.invoke("LeaveRoom", "@room?.RoomCode");
    }
    if (timerInterval) {
        clearInterval(timerInterval);
    }
});
</script> 